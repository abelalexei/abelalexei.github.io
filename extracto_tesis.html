<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor de Tesis PhD - PDF Embed</title>
    <!-- Tailwind CSS para un diseño moderno y responsivo --><script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Estilo para el cuerpo y la fuente principal */
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }
        /* Estilo para el contenedor principal del visor */
        #viewer-container {
            width: 100%;
            max-width: 1024px;
            min-height: 80vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        /* Estilo para el embed PDF */
        embed {
            width: 100%;
            height: 80vh;
            border: 1px solid #374151; /* gray-700 */
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #fallback-container {
            display: none;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased">

    <div class="container mx-auto px-4 py-8 md:py-12">
        <header class="mb-8 flex flex-col md:flex-row justify-center items-center text-center md:space-x-8">
            <!-- Logo de la UES con ruta absoluta --><img src="https://raw.githubusercontent.com/abelalexei/abelalexei.github.io/main/images/logo_ues.png" alt="Logo UES" class="h-24 md:h-28 mb-4 md:mb-0 flex-shrink-0">
            
            <!-- Títulos --><div class="max-w-2xl">
                <h1 class="text-3xl md:text-4xl font-bold text-cyan-400">Extracto de Tesis Doctoral (PDF.js)</h1>
                <p class="text-lg md:text-xl text-gray-400 mt-2">Geomorfología aplicada</p>
                <p class="text-md md:text-lg text-gray-300 mt-2">Escuela de Posgrado y Educación Continua, Facultad de Ciencias Agronómicas, Universidad de El Salvador</p>
            </div>

            <!-- Logo Agronomía con ruta absoluta --><img src="https://raw.githubusercontent.com/abelalexei/abelalexei.github.io/main/images/logo_agronomia.png" alt="Logo Agronomía" class="h-24 md:h-28 mt-4 md:mt-0 flex-shrink-0">
        </header>

        <main class="flex flex-col items-center">
            <!-- Controles (solo para fallback PDF.js) -->
            <div id="controls-container" class="hidden mb-4 w-full max-w-6xl flex justify-between items-center bg-gray-800 p-3 rounded-lg shadow-xl border border-gray-700">
                <button id="prev-page" class="nav-button flex items-center bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md shadow disabled:opacity-50">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Anterior
                </button>

                <div class="text-lg font-mono text-cyan-400">
                    Página <span id="current-page">...</span> de <span id="total-pages">...</span>
                </div>
                
                <button id="next-page" class="nav-button flex items-center bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md shadow disabled:opacity-50">
                    Siguiente
                    <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            
            <!-- Contenedor del visor del PDF -->
            <div id="viewer-container" class="w-full max-w-6xl bg-gray-800 rounded-lg shadow-2xl overflow-y-auto border-2 border-gray-700 p-4">
                <!-- Método 1: Embed nativo (preferido) -->
                <embed id="pdf-embed" type="application/pdf" class="hidden" />
                
                <!-- Método 2: Fallback a PDF.js (canvas) -->
                <div id="fallback-container" class="w-full">
                    <div id="loading-message" class="text-center p-12 text-gray-400 text-xl">
                        Cargando PDF...
                    </div>
                    <canvas id="pdf-canvas" class="hidden mx-auto"></canvas>
                </div>
            </div>
        </main>

        <footer class="text-center text-gray-600 mt-12">
            <p>Visualización impulsada por PDF.js.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // URLs del PDF (raw de GitHub y fallback local)
            const PDF_URL_GITHUB = 'https://raw.githubusercontent.com/abelalexei/abelalexei.github.io/main/Extracto%20de%20tesis%20PhD%20Abel%20Argueta.pdf';
            const PDF_URL_LOCAL = 'pdfs/extracto_tesis.pdf';
            
            // Referencias del DOM
            const pdfEmbed = document.getElementById('pdf-embed');
            const fallbackContainer = document.getElementById('fallback-container');
            const controlsContainer = document.getElementById('controls-container');
            const canvas = document.getElementById('pdf-canvas');
            const loadingMessage = document.getElementById('loading-message');
            let usingFallback = false;

            // **MÉTODO 1: EMBED NATIVO (Preferido)**
            function initEmbedViewer() {
                console.log('Intentando cargar PDF con embed nativo...');
                pdfEmbed.src = PDF_URL_GITHUB;
                pdfEmbed.classList.remove('hidden');
                
                // Timeout para detectar si embed falló silenciosamente
                setTimeout(() => {
                    // Si embed falló, cambiar a PDF.js
                    if (!pdfEmbed.src || pdfEmbed.offsetHeight === 0) {
                        console.warn('Embed nativo falló o no se cargó, usando fallback PDF.js...');
                        switchToFallback();
                    }
                }, 3000);
            }

            // **MÉTODO 2: FALLBACK A PDF.js**
            async function switchToFallback() {
                usingFallback = true;
                pdfEmbed.classList.add('hidden');
                fallbackContainer.style.display = 'block';
                controlsContainer.classList.remove('hidden');
                
                // Configurar PDF.js worker
                const workerUrl = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.worker.min.js';
                if (typeof pdfjsLib !== 'undefined') {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = workerUrl;
                } else {
                    console.error('PDF.js no disponible');
                    loadingMessage.innerHTML = '<span class="text-red-400">Error: PDF.js no disponible y embed falló.</span>';
                    return;
                }
                
                // Referencias para PDF.js fallback
                const ctx = canvas.getContext('2d');
                const currentPageSpan = document.getElementById('current-page');
                const totalPagesSpan = document.getElementById('total-pages');
                const prevButton = document.getElementById('prev-page');
                const nextButton = document.getElementById('next-page');

                let pdfDoc = null;
                let pageNum = 1;
                let pageRendering = false;
                let pageNumPending = null;

                async function renderPage(num) {
                    pageRendering = true;
                    try {
                        const page = await pdfDoc.getPage(num);
                        const containerWidth = document.getElementById('viewer-container').clientWidth - 32;
                        const viewport = page.getViewport({ scale: 1 });
                        const desiredScale = containerWidth / viewport.width;
                        const finalViewport = page.getViewport({ scale: desiredScale });

                        canvas.height = finalViewport.height;
                        canvas.width = finalViewport.width;
                        
                        const renderContext = {
                            canvasContext: ctx,
                            viewport: finalViewport,
                        };
                        
                        const renderTask = page.render(renderContext);
                        await renderTask.promise;
                        
                        pageRendering = false;

                        if (pageNumPending !== null) {
                            renderPage(pageNumPending);
                            pageNumPending = null;
                        }
                        
                        updatePageControls();

                    } catch (error) {
                        console.error(`Error al renderizar página ${num}:`, error);
                        pageRendering = false;
                    }
                }
                
                function queueRenderPage(num) {
                    if (pageRendering) {
                        pageNumPending = num;
                    } else {
                        renderPage(num);
                    }
                }

                function onPrevPage() {
                    if (pageNum <= 1) return;
                    pageNum--;
                    queueRenderPage(pageNum);
                }

                function onNextPage() {
                    if (pageNum >= pdfDoc.numPages) return;
                    pageNum++;
                    queueRenderPage(pageNum);
                }
                
                function updatePageControls() {
                    currentPageSpan.textContent = pageNum;
                    prevButton.disabled = pageNum <= 1;
                    nextButton.disabled = pageNum >= pdfDoc.numPages;
                    canvas.classList.remove('hidden');
                    loadingMessage.classList.add('hidden');
                }

                prevButton.addEventListener('click', onPrevPage);
                nextButton.addEventListener('click', onNextPage);
                
                async function tryLoadPdf(url, timeoutMs = 5000) {
                    return new Promise(async (resolve) => {
                        let completed = false;
                        const timeout = setTimeout(() => {
                            if (!completed) {
                                completed = true;
                                console.warn(`Timeout al cargar PDF desde ${url}`);
                                resolve(null);
                            }
                        }, timeoutMs);
                        
                        try {
                            const pdfData = await pdfjsLib.getDocument({ 
                                url: url,
                                disableRange: true, 
                                withCredentials: false 
                            }).promise;
                            
                            if (!completed) {
                                completed = true;
                                clearTimeout(timeout);
                                resolve(pdfData);
                            }
                        } catch (error) {
                            if (!completed) {
                                completed = true;
                                clearTimeout(timeout);
                                console.warn(`Error al cargar PDF desde ${url}:`, error.message);
                                resolve(null);
                            }
                        }
                    });
                }
                
                // Cargar PDF: intentar GitHub primero, luego local
                loadingMessage.textContent = 'Cargando PDF con PDF.js (GitHub → Local)...';
                let pdfData = await tryLoadPdf(PDF_URL_GITHUB, 5000);
                
                if (!pdfData) {
                    loadingMessage.textContent = 'Intentando carga local...';
                    pdfData = await tryLoadPdf(PDF_URL_LOCAL, 5000);
                }
                
                if (!pdfData) {
                    loadingMessage.innerHTML = `<span class="text-red-400">
                        Error: No se pudo cargar el PDF.<br>
                        Intenta colocarlo en: <code>C:\\SIG_MCGIA\\pdfs\\extracto_tesis.pdf</code>
                    </span>`;
                    return;
                }
                
                pdfDoc = pdfData;
                totalPagesSpan.textContent = pdfDoc.numPages;
                renderPage(pageNum);

                window.addEventListener('resize', () => {
                    queueRenderPage(pageNum); 
                });
            }

            // Iniciar con embed nativo (preferido)
            initEmbedViewer();
        });
    </script>
    <!-- Incluir PDF.js desde CDN como fallback -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.js"></script>
</body>
</html>
